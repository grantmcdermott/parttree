<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Abstract art with parttree and friends • parttree</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Abstract art with parttree and friends">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="default" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">parttree</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/parttree-intro.html">Introduction to parttree</a></li>
    <li><a class="dropdown-item" href="../articles/parttree-art.html">Abstract art with parttree and friends</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/grantmcdermott/parttree"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Abstract art with parttree and friends</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/grantmcdermott/parttree/blob/v0.1.1/vignettes/parttree-art.Rmd" class="external-link"><code>vignettes/parttree-art.Rmd</code></a></small>
      <div class="d-none name"><code>parttree-art.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>One fun application of tree-based methods is abstracting over art and
other images. For some really striking examples, take a look at the
portfoilo of <a href="https://www.dimitris-ladopoulos.xyz/projects/portraits.html" class="external-link">Dimitris
Ladopoulos</a>. This vignette will show you how to implement the same
basic ideas using <strong>parttree</strong> and a few friends. Here are
the packages that we’ll be using.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://grantmcdermott.com/parttree/">parttree</a></span><span class="op">)</span> <span class="co"># This package</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bethatkinson/rpart" class="external-link">rpart</a></span><span class="op">)</span>    <span class="co"># For decision trees</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick/" class="external-link">magick</a></span><span class="op">)</span>   <span class="co"># For reading and manipulating images</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://asgr.github.io/imager/" class="external-link">imager</a></span><span class="op">)</span>   <span class="co"># Another image library, with some additional features</span></span>
<span></span>
<span><span class="va">op</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="co"># Remove plot margins</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">magick</span><span class="fu">:::</span><span class="fu">magick_threads</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2</span></span></code></pre></div>
<p>While the exact details will vary depending on the image at hand, the
essential recipe for this type of art abstraction is as follows:</p>
<ol style="list-style-type: decimal">
<li>Convert the image to a matrix (or data frame), where rows and
columns correspond, respectively, to the X and Y coordinates of
individual pixels. In other words, each cell in our matrix (data frame)
represents the colour values of an individual pixel.</li>
<li>Split the data by primary (RGB) colour channels. We should now have
three matrices (data frames), where each cell represents the
red/green/blue colour channel value of an individual pixel.</li>
<li>Run a tree model on our three RGB datasets. In each case, we are
trying to predict the relevant colour channel value as a function of the
X and Y coordinates.</li>
<li>Use the predicted values to plot the abstracted art piece! (Okay,
this step requires a bit more work, but we’re about to see how it works
in practice…)</li>
</ol>
</div>
<div class="section level2">
<h2 id="example-1-peales-portrait-of-rosalba">Example 1: Peale’s “Portrait of Rosalba”<a class="anchor" aria-label="anchor" href="#example-1-peales-portrait-of-rosalba"></a>
</h2>
<p>Our first example, will mimic one of Dimitri Ladopoulos’s
aforementioned portrait pieces. Specifically, we will abstract over a
close-up (eyes only) of Rembrandt Peale’s <a href="https://en.wikipedia.org/wiki/File:Rembrandt_Peale_-_Portrait_of_Rosalba_Peale_-_Google_Art_Project.jpg" class="external-link">portrait
of his daughter, Rosalba</a>.</p>
<p>We can download a digital image of the original artwork from
Wikimedia. I’ll download a high-res version to show off, but feel free
to go for a lower resolution if you want to reduce modeling and plotting
times.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;For example, you can download &lt;a href="https://upload.wikimedia.org/wikipedia/commons/thumb/a/aa/Rembrandt_Peale_-_Portrait_of_Rosalba_Peale_-_Google_Art_Project.jpg/556px-Rembrandt_Peale_-_Portrait_of_Rosalba_Peale_-_Google_Art_Project.jpg" class="external-link"&gt;this
version&lt;/a&gt; instead and adapt your cropping command to
&lt;code&gt;rosalba = image_crop(rosalba, "170x90+170+260")&lt;/code&gt;.&lt;/p&gt;'><sup>1</sup></a>
However, I will crop the image around Rosalba’s eyes to get a close-up
and reduce the overall complexity of the exercise.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;One minor faff is that I’m using two separate
packages—&lt;strong&gt;magick&lt;/strong&gt; and &lt;strong&gt;imager&lt;/strong&gt; to prep the
image. Without going into the details, just know that the former is
better for cropping the image the way I want, while the latter is better
for R’s in-memory manipulation.&lt;/p&gt;"><sup>2</sup></a></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Download the image</span></span>
<span><span class="va">rosalba</span> <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html" class="external-link">image_read</a></span><span class="op">(</span><span class="st">"https://upload.wikimedia.org/wikipedia/commons/a/aa/Rembrandt_Peale_-_Portrait_of_Rosalba_Peale_-_Google_Art_Project.jpg"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Crop around the eyes</span></span>
<span><span class="va">rosalba</span> <span class="op">=</span> <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html" class="external-link">image_crop</a></span><span class="op">(</span><span class="va">rosalba</span>, <span class="st">"850x400+890+1350"</span><span class="op">)</span></span>
<span><span class="co"># rosalba = image_crop(rosalba, "750x350+890+1350")</span></span>
<span></span>
<span><span class="co"># Convert to cimg (better for in-memory manipulation)</span></span>
<span><span class="va">rosalba</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/imager/man/magick.html" class="external-link">magick2cimg</a></span><span class="op">(</span><span class="va">rosalba</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Display</span></span>
<span><span class="va">rosalba</span></span>
<span><span class="co">#&gt; Image. Width: 850 pix Height: 400 pix Depth: 1 Colour channels: 3</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rosalba</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="parttree-art_files/figure-html/peale-download-1.png" width="90%"></p>
<p>With our cropped image in hand, let’s walk through the 4-step recipe
from above.</p>
<p><strong>Step 1.</strong> Convert the image into a data frame.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Coerce to data frame</span></span>
<span><span class="va">rosalba_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">rosalba</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Round color values to ease up work for decision tree</span></span>
<span><span class="va">rosalba_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rosalba_df</span><span class="op">$</span><span class="va">value</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">rosalba_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;   x y cc  value</span></span>
<span><span class="co">#&gt; 1 1 1  1 0.3059</span></span>
<span><span class="co">#&gt; 2 2 1  1 0.3059</span></span>
<span><span class="co">#&gt; 3 3 1  1 0.2627</span></span>
<span><span class="co">#&gt; 4 4 1  1 0.2471</span></span>
<span><span class="co">#&gt; 5 5 1  1 0.3137</span></span>
<span><span class="co">#&gt; 6 6 1  1 0.2941</span></span></code></pre></div>
<p><strong>Step 2.</strong> Split the image by RGB colour channel. This
is the <code>cc</code> column above, where 1=Red, 2=Green, and
3=Blue.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rosalba_ccs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">rosalba_df</span>, <span class="va">rosalba_df</span><span class="op">$</span><span class="va">cc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We have a list of three DFs by colour channel. Uncomment if you want to see:</span></span>
<span><span class="co"># str(rosalba_css)</span></span></code></pre></div>
<p><strong>Step 3.</strong> Fit a decision tree (or similar model) on
each of our colour channel data frames. The tuning parameters that you
give your model are a matter of experimentation. Here I’m giving it a
low complexity parameter (so we see more variation in the final
predictions) and trimming each tree to a maximum depth of 30 nodes. The
next code chunk takes about 15 seconds to run on my laptop, but should
be much quicker if you downloaded a lower-res image.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Start creating regression tree for each color channel. We'll adjust some</span></span>
<span><span class="co">## control parameters to give us the "right" amount of resolution in the final</span></span>
<span><span class="co">## plots.</span></span>
<span><span class="va">trees</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">rosalba_ccs</span>, </span>
<span>  <span class="co"># function(d) rpart(value ~ x + y, data=d, control=list(cp=0.00001, maxdepth=20))</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html" class="external-link">rpart</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span>, data<span class="op">=</span><span class="va">d</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cp<span class="op">=</span><span class="fl">0.00002</span>, maxdepth<span class="op">=</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><strong>Step 4.</strong> Use our model (colour) predictions to
construct our abstracted art piece. I was bit glib about it earlier,
since it really involves a few sub-steps. First, let’s grab the
predictions for each of our trees.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">trees</span>, <span class="va">predict</span><span class="op">)</span> <span class="co"># get predictions for each tree</span></span></code></pre></div>
<p>We’re going to use these predictions to draw the abstracted
(downscaled) version of our image.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Remember: the tree model predictions yield “average”
colours for small sub-regions of the original image. This is how we get
the downscaling effect.&lt;/p&gt;"><sup>3</sup></a> Probably the easiest way to do this is by
taking the predictions and overwriting the “value” column of our
original (pre-split) <code>rosalba_df</code> data frame. We can then
coerce the data frame back into a <code>cimg</code> object, which comes
with a bunch of nice plotting methods.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The pred object is a list, so we convert it to a vector before overwriting the</span></span>
<span><span class="co"># value column of the original data frame</span></span>
<span><span class="va">rosalba_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="va">pred</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert back into a cimg object, with the predictions providing pixel values</span></span>
<span><span class="va">pred_img</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html" class="external-link">as.cimg</a></span><span class="op">(</span><span class="va">rosalba_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in as.cimg.data.frame(rosalba_df): Guessing image dimensions from</span></span>
<span><span class="co">#&gt; maximum coordinate values</span></span></code></pre></div>
<p>Now we’re ready to draw our abstracted art piece. It’s also where
<strong>parttree</strong> will enter the fray, since this is what we’ll
be using to highlight the partitioned areas of the downscaled pixels.
Here’s how we can do it using base R graphics.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get a list of parttree data frames (one for each tree)</span></span>
<span><span class="va">pts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">trees</span>, <span class="va">parttree</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## first plot the downscaled image...</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">pred_img</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## ... then layer the partitions as a series of rectangles</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">pts</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pt</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>    <span class="va">pt</span>, raw <span class="op">=</span> <span class="cn">FALSE</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, expand <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    fill_alpha <span class="op">=</span> <span class="cn">NULL</span>, lwd <span class="op">=</span> <span class="fl">0.1</span>, border <span class="op">=</span> <span class="st">"grey15"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="parttree-art_files/figure-html/rosalba_abstract-1.png" width="90%"></p>
<pre><code><span><span class="co">#&gt; $`1`</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`2`</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`3`</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre>
<p>We can achieve the same effect with <strong>ggplot2</strong> if you
prefer to use that.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_raster.html" class="external-link">annotation_raster</a></span><span class="op">(</span><span class="va">pred_img</span>,  ymin<span class="op">=</span><span class="op">-</span><span class="cn">Inf</span>, ymax<span class="op">=</span><span class="cn">Inf</span>, xmin<span class="op">=</span><span class="op">-</span><span class="cn">Inf</span>, xmax<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">trees</span>, <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="../reference/geom_parttree.html">geom_parttree</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, lwd <span class="op">=</span> <span class="fl">0.05</span>, col <span class="op">=</span> <span class="st">"grey15"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rosalba_df</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">rosalba_df</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span>ratio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Reduce</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">rosalba</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="fl">1</span><span class="op">]</span>, f <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="parttree-art_files/figure-html/rosalba_abstract_gg-1.png" width="90%"></p>
</div>
<div class="section level2">
<h2 id="example-2-parttree-logo">Example 2: parttree logo<a class="anchor" aria-label="anchor" href="#example-2-parttree-logo"></a>
</h2>
<p>Now that we’ve walked through a detailed example, let’s quickly go
through one more. We’re about to get very <em>meta</em>: Visualizing the
decision tree partitions of an actual tree image. This also happens to
be the basis for the <strong>parttree</strong> <a href="https://github.com/grantmcdermott/parttree/blob/main/man/figures/hex.png" class="external-link">logo</a>,
which seems a nice way to bookend the vignette.</p>
<p>Here are the main image conversion, modeling, and prediction steps.
These follow the same recipe that we saw in the previous portrait
example, so I won’t repeat my explanations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bonzai</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/imager/man/load.image.html" class="external-link">load.image</a></span><span class="op">(</span><span class="st">"https://upload.wikimedia.org/wikipedia/commons/thumb/0/0c/Japanese_Zelkova_bonsai_16%2C_30_April_2012.JPG/480px-Japanese_Zelkova_bonsai_16%2C_30_April_2012.JPG"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bonzai</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="parttree-art_files/figure-html/bonzai-1.png" width="90%"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Coerce to data frame</span></span>
<span><span class="va">bonzai_df</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">bonzai</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Round color values to ease up work for decision trees</span></span>
<span><span class="va">bonzai_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">bonzai_df</span><span class="op">$</span><span class="va">value</span>, <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split into colour channels</span></span>
<span><span class="va">bonzai_ccs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">bonzai_df</span>, <span class="va">bonzai_df</span><span class="op">$</span><span class="va">cc</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit decision trees on each colour channel DF. Note that I'm deliberating</span></span>
<span><span class="co"># truncating the max tree depth to reduce the number of partitions.</span></span>
<span><span class="va">bonzai_trees</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="va">bonzai_ccs</span>, </span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">d</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/rpart/man/rpart.html" class="external-link">rpart</a></span><span class="op">(</span><span class="va">value</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">y</span>, data<span class="op">=</span><span class="va">d</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cp<span class="op">=</span><span class="fl">0.00001</span>, maxdepth<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Overwrite value column with predictions vector</span></span>
<span><span class="va">bonzai_df</span><span class="op">$</span><span class="va">value</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bonzai_trees</span>, <span class="va">predict</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert back into a cimg object, with the predictions providing pixel values</span></span>
<span><span class="va">bonzai_pred_img</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/imager/man/as.cimg.html" class="external-link">as.cimg</a></span><span class="op">(</span><span class="va">bonzai_df</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in as.cimg.data.frame(bonzai_df): Guessing image dimensions from</span></span>
<span><span class="co">#&gt; maximum coordinate values</span></span></code></pre></div>
<p>At this point you may tempted to plot the figure with
<code>plot(bonzai_pred_img)</code>, which would definitely work.
However, I’m going to show you one additional tweak to make the
partition rectangles look a bit nicer: Use mean color channel values
instead of black. Here’s a function for grabbing this information from a
<code>cimg</code> object that has been converted to a data frame.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;I honestly can’t remember where I first saw this trick
or adapted this function from. But it works particularly well in cases
like this where we want the partition lines to blend in with the main
image.&lt;/p&gt;"><sup>4</sup></a></p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mean_cols</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mcols</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">dat</span><span class="op">$</span><span class="va">value</span>, <span class="va">dat</span><span class="op">$</span><span class="va">cc</span>, FUN <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span>  <span class="va">col1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="va">mcols</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">mcols</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="va">mcols</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">hicol</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.4</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="va">col2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fu">hicol</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, <span class="fu">hicol</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, <span class="fu">hicol</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">3</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">locol</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">-</span> <span class="fl">0.4</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>  <span class="va">col3</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fu">locol</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, <span class="fu">locol</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">2</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span>, <span class="fu">locol</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">dat</span>, <span class="va">cc</span><span class="op">==</span><span class="fl">3</span><span class="op">)</span><span class="op">$</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">col1</span>, <span class="va">col2</span>, <span class="va">col3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">bonzai_mean_cols</span> <span class="op">=</span> <span class="fu">mean_cols</span><span class="op">(</span><span class="va">bonzai_df</span><span class="op">)</span></span></code></pre></div>
<p>The penultimate step is to generate <code>parttree</code> objects
from each of our colour channel-based trees.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bonzai_pts</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bonzai_trees</span>, <span class="va">parttree</span><span class="op">)</span></span></code></pre></div>
<p>And now we can plot everything together.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bonzai_pred_img</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">pt</span>, <span class="va">cols</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>      <span class="va">pt</span>, raw <span class="op">=</span> <span class="cn">FALSE</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, expand <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      fill_alpha <span class="op">=</span> <span class="fl">0</span>, lwd <span class="op">=</span> <span class="fl">0.2</span>, border <span class="op">=</span> <span class="va">cols</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  pt <span class="op">=</span> <span class="va">bonzai_pts</span>,</span>
<span>  cols <span class="op">=</span> <span class="va">bonzai_mean_cols</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="parttree-art_files/figure-html/bonza_abstract-1.png" width="90%"></p>
<pre><code><span><span class="co">#&gt; $`1`</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`2`</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $`3`</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre>
<p>Again, equivalent result for those prefer
<strong>ggplot2</strong>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># library(ggplot2)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotation_raster.html" class="external-link">annotation_raster</a></span><span class="op">(</span><span class="va">bonzai_pred_img</span>,  ymin<span class="op">=</span><span class="op">-</span><span class="cn">Inf</span>, ymax<span class="op">=</span><span class="cn">Inf</span>, xmin<span class="op">=</span><span class="op">-</span><span class="cn">Inf</span>, xmax<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/funprog.html" class="external-link">Map</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">d</span>, <span class="va">cols</span><span class="op">)</span> <span class="fu"><a href="../reference/geom_parttree.html">geom_parttree</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">d</span>, lwd <span class="op">=</span> <span class="fl">0.1</span>, col <span class="op">=</span> <span class="va">cols</span><span class="op">)</span>, d <span class="op">=</span> <span class="va">bonzai_trees</span>, cols <span class="op">=</span> <span class="va">bonzai_mean_cols</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bonzai_df</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_reverse</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">bonzai_df</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span>, expand<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="parttree-art_files/figure-html/unnamed-chunk-2-1.png" width="90%"></p>
</div>
<div class="section level2">
<h2 id="postscript">Postscript<a class="anchor" aria-label="anchor" href="#postscript"></a>
</h2>
<p>The individual trees for each colour channel make for nice stained
glass prints…</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">bonzai_pts</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>      <span class="va">bonzai_pts</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, raw <span class="op">=</span> <span class="cn">FALSE</span>, expand <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      axes <span class="op">=</span> <span class="cn">FALSE</span>, legend <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"R"</span>, <span class="st">"G"</span>, <span class="st">"B"</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      <span class="co">## Aside: We're reversing the y-scale since higher values actually</span></span>
<span>      <span class="co">## correspond to points lower on the image, visually.</span></span>
<span>      ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">bonzai_pts</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="st">"parttree"</span><span class="op">)</span><span class="op">[[</span><span class="st">"yrange"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span> </span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="parttree-art_files/figure-html/bonzai_glass-1.png" width="90%"><img src="parttree-art_files/figure-html/bonzai_glass-2.png" width="90%"><img src="parttree-art_files/figure-html/bonzai_glass-3.png" width="90%"></p>
<pre><code><span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; NULL</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; [[3]]</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reset the plot margins</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Grant McDermott.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>





  </body>
</html>
